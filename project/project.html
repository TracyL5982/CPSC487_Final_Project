<!DOCTYPE html>
<html lang="en">
<head>
    <title>CPSC 487/587</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.3.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quaternion@1.5.1/quaternion.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/numeric@1.2.6/numeric-1.2.6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stats.js@0.17.0/build/stats.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/": "https://unpkg.com/three@0.160.0/"
            }
        }
        </script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="../js/utils/tree.js"></script>
    <script src="../js/utils/tree_geometry.js"></script>
    <script src="../js/utils/tree_helper.js"></script>
</head>
<body>
<script type="module">
    import { get_default_lil_gui, ThreeEngine, refresh_displays } from "../js/utils/utils_three.js";
    import { mul_matrix_matrix } from "../js/utils/utils_math.js";
    import { genLeafMesh } from "../js/utils/leaf.js"

    // data to generate a randomized tree
    const trees = [
            {
                name: 'peach',
                parameters: {
                    generations: 6,
                    length: 13,
                    uvLength: 78,
                    radius: 1.5,
                    radiusSegments: 10,
                    heightSegments: 5,
                    branchTheta: 0.25 * Math.PI
                },
                leafShape: 'rect',
                leafType: 'peach',
                leafScale: 2,
                leafScaleX: 1
            },
            {
                name: 'poinciana',
                parameters: {
                    generations: 5,
                    length: 6,
                    uvLength: 30,
                    radius: 0.5,
                    radiusSegments: 10,
                    heightSegments: 8,
                    branchTheta: 0.2 * Math.PI
                },
                leafShape: 'rect',
                leafType: 'poinciana',
                leafScale: 3,
                leafScaleX: 1
            },
            {
                name: 'pine',
                parameters: {
                    generations: 4,
                    length: 5.0,
                    uvLength: 20.0,
                    radius: 1.0,
                    radiusSegments: 10,
                    heightSegments: 15,
                    branchTheta: 0.3 * Math.PI
                },
                leafShape: 'rect',
                leafType: 'pine',
                leafScale: 3,
                leafScaleX: 3
            },
            {
                name: 'aspen',
                parameters: {
                    generations: 5,
                    length: 10.0,
                    uvLength: 24.0,
                    radius: 0.5,
                    radiusSegments: 10,
                    heightSegments: 5,
                    branchTheta: 0.1 * Math.PI
                },
                leafShape: 'rect',
                leafType: 'aspen',
                leafScale: 4,
                leafScaleX: 1
            },
            {
                name: 'maple',
                parameters: {
                    generations: 5,
                    length: 7.0,
                    uvLength: 35.0,
                    radius: 0.5,
                    radiusSegments: 10,
                    heightSegments: 5,
                    branchTheta: 0.2 * Math.PI
                },
                leafShape: 'rect',
                leafType: 'maple',
                leafScale: 2,
                leafScaleX: 1
            }
        ];

    const selectedTree = trees[Math.floor(Math.random() * trees.length)];

    let engine = ThreeEngine.new_default_3d(30, 10, 30, false, selectedTree.name);

    // GUI and other setup
   //let params = {
   //     generations: 5, //5 and 6 tends to yield the best results
   //     length: 6.0, //for tree height [3, 15]
   //     uvLength: 30.0, //recommend = generations * length
   //     radius: 0.5, //tree radius, [length/25, length/6]
   //     radiusSegments: 10, //recommend >= 8
   //     heightSegments: 8, // >=3, the larger heightSegments is, the curvier/smooth the tree branch will be
   //     branchTheta: 0.2 * Math.PI,
   // };

    //let operations = {
    //    reset: function() {
   //         params.generations = 4;
   //         params.length = 4.0;
   //         params.uvLength = 16.0;
   //         params.radius = 0.2;
   //         params.radiusSegments = 8;
   //         params.heightSegments = 8;
   //         refresh_displays(gui);
   //     }
   // };

    //let gui = get_default_lil_gui();
    //let folder = gui.addFolder("Parameters");
    //folder.add(params, 'generations', 1, 10).name('Generations');
    //folder.add(params, 'length', 1, 10).name('Length');
    //folder.add(params, 'uvLength', 5, 30).name('UVLength');
    //folder.add(params, 'radius', 0, 2).name('Radius');
    //folder.add(params, 'radiusSegments', 0, 20).name('RadiusSegments');
    //folder.add(params, 'heightSegments', 0, 20).name('HeightSegments');
    //folder.add(params, 'branchTheta', 0, 20).name('branchTheta');
    //gui.add(operations, 'reset').name('Reset parameters');

    // Generate tree branches

    var tree = new THREE.Tree(selectedTree.parameters);
    var treeGeometry = THREE.TreeGeometry.build(tree);

    var textureLoader = new THREE.TextureLoader();
    const barkPath = `../js/assets/bark_${selectedTree.name}.png`;
    textureLoader.load(barkPath, function(texture) {
        var treeMaterial = new THREE.MeshPhongMaterial({
            map: texture
        });
        var treeMesh = new THREE.Mesh(treeGeometry, treeMaterial);
        treeMaterial.shininess = 100;
        engine.scene.add(treeMesh);
    });

    //Generate tree leaves
    genLeafMesh(tree, selectedTree.leafShape, selectedTree.leafType, selectedTree.leafScale, selectedTree.leafScaleX, engine);

    engine.animation_loop((delta) => {
    });

</script>
</body>
</html>

